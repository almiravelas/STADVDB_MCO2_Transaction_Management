<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB Manager</title>
    <link rel="stylesheet" href="/index.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <aside class="sidebar" id="sidebar">
        <button class="toggle-btn" id="sidebarToggle"><i class='bx bx-chevron-left'></i></button>
        <div class="sidebar-logo">
            <div style="width:35px; height:35px; background:rgba(255,255,255,0.2); border-radius:8px; display:flex; align-items:center; justify-content:center;">
                <i class='bx bxs-component'></i>
            </div>
            <span class="logo-text">DB Admin</span>
        </div>
        <nav>
            <button class="nav-item active" data-view="overview"><i class='bx bxs-dashboard'></i><span class="nav-text">Dashboard</span></button>
            <button class="nav-item" data-view="search"><i class='bx bx-search-alt'></i><span class="nav-text">Search User</span></button>
            <button class="nav-item" data-view="country"><i class='bx bxs-map-alt'></i><span class="nav-text">Filter Location</span></button>
            <button class="nav-item" data-view="viewall"><i class='bx bxs-folder'></i><span class="nav-text">View All Data</span></button>
            <div style="margin-top:auto; padding-top:20px; border-top:1px solid rgba(255,255,255,0.2);">
                 <button class="nav-item" data-view="health"><i class='bx bx-pulse'></i><span class="nav-text">System Health</span></button>
            </div>
        </nav>
    </aside>

    <main class="main-content">
        <header class="header">
            <div><h1 id="pageTitle">Dashboard</h1><p>Welcome back, Administrator</p></div>
            <button class="btn-primary" id="btnAddUser"><i class='bx bx-plus'></i><span>Add User</span></button>
        </header>

        <section id="overview-section" class="content-section active">
            <div class="dashboard-grid">
                <div class="stats-area">
                    <div class="overview-row">
                        <div class="card-purple">
                            <p style="opacity:0.8; font-size:12px; text-transform:uppercase; letter-spacing:1px;">Total Users</p>
                            <h1 id="totalUsers">--</h1>
                            <p style="opacity:0.8; font-size:13px;">Active database records</p>
                        </div>
                        <div class="card-pink">
                            <h3 style="font-size:16px;">Quick Actions</h3>
                            <button class="qa-btn" onclick="document.querySelector('[data-view=search]').click()">
                                <i class='bx bx-search' style="font-size:20px;"></i> <span>Search ID</span>
                            </button>
                            <button class="qa-btn" onclick="document.querySelector('[data-view=country]').click()">
                                <i class='bx bx-map' style="font-size:20px;"></i> <span>Filter Country</span>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3 style="color:#2B3674; font-size:18px;">Registration Analytics</h3>
                            <span style="background:#F4F7FE; color:#6C5CE7; padding:5px 15px; border-radius:20px; font-size:12px; font-weight:600;">Monthly View</span>
                        </div>
                        <canvas id="growthChart"></canvas>
                    </div>
                </div>
                <div class="history-panel">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <h3 style="font-size:16px;">Activity Log</h3>
                        <button onclick="clearHistory()" style="border:none; background:none; color:#FF6B9D; cursor:pointer;">Clear</button>
                    </div>
                    <div id="transactionList"><p style="color:#aaa; text-align:center; font-size:12px;">No recent activity</p></div>
                </div>
            </div>
        </section>

        <section id="search-section" class="content-section">
            <div class="card-clean">
                <h2>Search User</h2>
                <form id="searchForm" style="display:flex; gap:15px; margin-top:25px;">
                    <input type="text" id="searchId" class="input-field" placeholder="ID or Name..." style="margin-bottom:0;" required>
                    <button type="submit" class="btn-primary">Search</button>
                </form>
                <div id="searchResult" style="display:none; margin-top:30px; background:#FAFAFA; padding:25px; border-radius:20px; border:1px solid #eee;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h2 id="resultName" style="color:#333;">Name</h2>
                            <p style="color:#888;">ID: <span id="resultId">--</span> | <span id="resultCity">--</span></p>
                        </div>
                        
                        <div class="action-gap">
                            <button id="btnEditSearch" class="btn-soft btn-soft-blue" title="Edit"><i class='bx bx-edit-alt'></i></button>
                            <button id="btnDeleteSearch" class="btn-soft btn-soft-red" title="Delete"><i class='bx bx-trash'></i></button>
                        </div>

                    </div>
                </div>
            </div>
        </section>

        <section id="country-section" class="content-section">
            <div class="card-clean">
                <h2>Filter Location</h2>
                <form id="countryForm" style="display:flex; gap:15px; margin-top:20px;">
                    <select id="countrySelect" class="input-field" style="margin-bottom:0;">
                        <option value="">Select Country...</option>
                        <option value="Philippines">Philippines</option>
                        <option value="USA">USA</option>
                        <option value="Mexico">Mexico</option>
                        <option value="Canada">Canada</option>
                        <option value="Australia">Australia</option>
                        <option value="Germany">Germany</option>
                    </select>
                    <button type="submit" class="btn-primary">Filter</button>
                </form>
                <div id="usersList" style="margin-top:30px; display:none;">
                    <h3 style="margin-bottom:15px; color:#2B3674;">Results</h3>
                    <div id="usersContainer" class="users-grid"></div>
                </div>
            </div>
        </section>

        <section id="viewall-section" class="content-section">
            <div class="card-clean">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>All Records</h2>
                    <span style="background:#E2FBD7; color:#34B53A; padding:5px 12px; border-radius:20px; font-size:12px; font-weight:600;">Live Data</span>
                </div>
                <div style="overflow-x:auto; margin-top:20px;">
                    <table class="data-table">
                        <thead>
                            <tr style="border-bottom:1px solid #eee; color:#A3AED0; font-size:12px;">
                                <th style="padding:15px;">ID</th><th>USERNAME</th><th>NAME</th><th>COUNTRY</th><th style="text-align:right;">ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="allDataTableBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="health-section" class="content-section">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>System Health</h2>
                <button class="btn-refresh" onclick="updateStats()">
                    <i class='bx bx-refresh'></i> Refresh
                </button>
            </div>
            
            <div class="node-grid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; margin-top:20px;">
                <div class="node-card" style="background:white; padding:30px; border-radius:20px; box-shadow:0 5px 20px rgba(0,0,0,0.05); text-align:center;">
                    <i class='bx bx-server' style="font-size:40px; color:#6C5CE7;"></i>
                    <h3 style="margin-top:10px; color:#2B3674;">Central DB</h3>
                    <p style="font-size:12px; color:#aaa; margin-bottom:15px;">Master Node</p>
                    <span id="node0Status" style="background:#E2FBD7; color:#34B53A; padding:5px 12px; border-radius:15px; font-weight:600; font-size:12px;">Connected</span>
                </div>
                <div class="node-card" style="background:white; padding:30px; border-radius:20px; box-shadow:0 5px 20px rgba(0,0,0,0.05); text-align:center;">
                    <i class='bx bx-hdd' style="font-size:40px; color:#FF6B9D;"></i>
                    <h3 style="margin-top:10px; color:#2B3674;">Partition 1</h3>
                    <p style="font-size:12px; color:#aaa; margin-bottom:15px;">M-Z Countries</p>
                    <span id="node1Status" style="background:#E2FBD7; color:#34B53A; padding:5px 12px; border-radius:15px; font-weight:600; font-size:12px;">Connected</span>
                </div>
                <div class="node-card" style="background:white; padding:30px; border-radius:20px; box-shadow:0 5px 20px rgba(0,0,0,0.05); text-align:center;">
                    <i class='bx bx-hdd' style="font-size:40px; color:#FF6B9D;"></i>
                    <h3 style="margin-top:10px; color:#2B3674;">Partition 2</h3>
                    <p style="font-size:12px; color:#aaa; margin-bottom:15px;">A-L Countries</p>
                    <span id="node2Status" style="background:#E2FBD7; color:#34B53A; padding:5px 12px; border-radius:15px; font-weight:600; font-size:12px;">Connected</span>
                </div>
            </div>
        </section>

    </main>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" style="text-align:center; margin-bottom:20px; color:#2B3674;">Edit User</h2>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="firstName" class="input-field" placeholder="First Name" required>
                    <input type="text" id="lastName" class="input-field" placeholder="Last Name" required>
                </div>
                <input type="text" id="username" class="input-field" placeholder="Username" required>
                <input type="text" id="city" class="input-field" placeholder="City" required>
                <select id="country" class="input-field" required>
                    <option value="Philippines">Philippines</option>
                    <option value="USA">USA</option>
                    <option value="Mexico">Mexico</option>
                    <option value="Canada">Canada</option>
                    <option value="Australia">Australia</option>
                    <option value="Germany">Germany</option>
                </select>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button type="button" id="btnCancelModal" style="flex:1; padding:12px; background:#f0f0f0; border:none; border-radius:10px; cursor:pointer;">Cancel</button>
                    <button type="submit" class="btn-primary" style="flex:1; justify-content:center;">Save</button>
                </div>
            </form>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // 1. SIDEBAR TOGGLE
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('sidebarToggle');
    toggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        toggleBtn.querySelector('i').classList.toggle('bx-chevron-right');
        toggleBtn.querySelector('i').classList.toggle('bx-chevron-left');
    });

    // 2. CHART
    const ctx = document.getElementById('growthChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'New Users',
                data: [12, 19, 3, 5, 2, 15],
                borderColor: '#6C5CE7',
                backgroundColor: 'rgba(108, 92, 231, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, grid:{borderDash:[5,5]} }, x:{grid:{display:false}} }
        }
    });

    // 3. NAVIGATION
    const navButtons = document.querySelectorAll('[data-view]');
    const sections = document.querySelectorAll('.content-section');
    const title = document.getElementById('pageTitle');

    navButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const view = btn.getAttribute('data-view');
            navButtons.forEach(b => b.classList.remove('active'));
            sections.forEach(s => s.classList.remove('active'));
            
            btn.classList.add('active');
            document.getElementById(view + '-section').classList.add('active');
            
            if(view === 'viewall') loadAllData();
            if(view === 'overview') updateStats();
            
            const titles = { overview: 'Dashboard', search: 'Search Database', country: 'Filter Location', viewall: 'All Records', health: 'System Health' };
            title.innerText = titles[view];
        });
    });

    // 4. HISTORY
    window.addTransaction = (type, name) => {
        const history = JSON.parse(localStorage.getItem('dbHistory')) || [];
        history.unshift({ type, name, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
        if(history.length > 10) history.pop();
        localStorage.setItem('dbHistory', JSON.stringify(history));
        renderHistory();
    }
    window.clearHistory = () => { localStorage.removeItem('dbHistory'); renderHistory(); }

    function renderHistory() {
        const list = document.getElementById('transactionList');
        const history = JSON.parse(localStorage.getItem('dbHistory')) || [];
        if(history.length === 0) { list.innerHTML = '<p style="color:#aaa; font-size:12px; text-align:center;">No recent activity</p>'; return; }

        list.innerHTML = '';
        history.forEach(h => {
            let color = '#6C5CE7', icon = 'bx-plus';
            if(h.type === 'edit') { color = '#2196F3'; icon = 'bx-pencil'; }
            if(h.type === 'delete') { color = '#FF5252'; icon = 'bx-trash'; }

            list.innerHTML += `
                <div class="history-item">
                    <div class="h-icon" style="background:${color};">
                        <i class='bx ${icon}'></i>
                    </div>
                    <div>
                        <p style="font-weight:600; font-size:14px; color:#2B3674; text-transform:capitalize;">${h.type}</p>
                        <p style="font-size:12px; color:#A0A5BA;">${h.name}</p>
                    </div>
                </div>`;
        });
    }
    renderHistory();

    // 5. SEARCH (BINDING BUTTONS)
    document.getElementById('searchForm').onsubmit = async (e) => {
        e.preventDefault();
        const q = document.getElementById('searchId').value;
        const resBox = document.getElementById('searchResult');
        try {
            let res = await fetch(`/api/users/search?id=${q}`);
            let data = await res.json();
            if(data.error || !data.id) { res = await fetch(`/api/users/search?name=${q}`); data = await res.json(); }
            
            if(data && (data.id || (Array.isArray(data) && data.length > 0))) {
                const u = Array.isArray(data) ? data[0] : data;
                resBox.style.display = 'block';
                document.getElementById('resultName').innerText = u.firstName + ' ' + u.lastName;
                document.getElementById('resultId').innerText = u.id;
                document.getElementById('resultCity').innerText = u.city;
                
                // Bind the buttons in search result
                document.getElementById('btnEditSearch').onclick = () => editUser(u.id, u.firstName, u.lastName, u.username, u.city, u.country);
                document.getElementById('btnDeleteSearch').onclick = () => deleteUser(u.id, u.firstName);
                
            } else { alert("User not found"); resBox.style.display = 'none'; }
        } catch(e) { alert("User not found"); }
    };

    // 6. FILTER
    document.getElementById('countryForm').onsubmit = async (e) => {
        e.preventDefault();
        const c = document.getElementById('countrySelect').value;
        if(!c) return;
        const res = await fetch(`/api/users/search?country=${c}`);
        const users = await res.json();
        
        document.getElementById('usersList').style.display = 'block';
        const box = document.getElementById('usersContainer');
        box.innerHTML = '';
        
        if(users.length > 0) {
            users.forEach(u => {
                box.innerHTML += `
                    <div class="user-card-new">
                        <div class="uc-icon"><i class='bx bxs-user'></i></div>
                        <div class="uc-info">
                            <h4>${u.firstName} ${u.lastName}</h4>
                            <p>${u.city}</p>
                            <p style="font-size:11px; margin-top:2px; color:#6C5CE7;">ID: ${u.id}</p>
                        </div>
                    </div>`;
            });
        } else { box.innerHTML = '<p style="color:#aaa;">No users found.</p>'; }
    };

    // 7. VIEW ALL (UPDATED WITH SOFT BUTTONS)
    window.loadAllData = async () => {
        const tbody = document.getElementById('allDataTableBody');
        tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
        try {
            const res = await fetch('/api/node/1/data?limit=50');
            const json = await res.json();
            tbody.innerHTML = '';
            if(json.data) {
                json.data.forEach(u => {
                    tbody.innerHTML += `
                    <tr>
                        <td style="padding:15px;">${u.id}</td>
                        <td>${u.username}</td>
                        <td>${u.firstName} ${u.lastName}</td>
                        <td>${u.country}</td>
                        <td style="text-align:right;">
                            <div class="action-gap">
                                <button class="btn-soft btn-soft-blue" onclick="editUser('${u.id}','${u.firstName}','${u.lastName}','${u.username}','${u.city}','${u.country}')"><i class='bx bx-edit-alt'></i></button>
                                <button class="btn-soft btn-soft-red" onclick="deleteUser('${u.id}','${u.firstName}')"><i class='bx bx-trash'></i></button>
                            </div>
                        </td>
                    </tr>`;
                });
            }
        } catch(e) { tbody.innerHTML = '<tr><td colspan="5">Error loading data</td></tr>'; }
    }

    // 8. CRUD
    const modal = document.getElementById('userModal');
    document.getElementById('btnAddUser').onclick = () => { 
        modal.style.display='flex'; 
        document.getElementById('userForm').reset(); 
        document.getElementById('userId').value=''; 
        document.getElementById('modalTitle').innerText="Add New User"; 
    };
    document.getElementById('btnCancelModal').onclick = () => modal.style.display='none';

    document.getElementById('userForm').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('userId').value;
        const data = {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            username: document.getElementById('username').value,
            city: document.getElementById('city').value,
            country: document.getElementById('country').value,
            gender: 'N/A'
        };
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/users/${id}` : '/api/users';
        try {
            await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            addTransaction(id ? 'edit' : 'add', data.firstName);
            alert("Success!");
            modal.style.display='none';
            updateStats();
            if(document.getElementById('viewall-section').classList.contains('active')) loadAllData();
        } catch(e) { alert("Error: " + e.message); }
    };

    window.editUser = (id,f,l,u,c,co) => {
        modal.style.display='flex';
        document.getElementById('userId').value=id; document.getElementById('firstName').value=f;
        document.getElementById('lastName').value=l; document.getElementById('username').value=u;
        document.getElementById('city').value=c; document.getElementById('country').value=co;
        document.getElementById('modalTitle').innerText="Edit User";
    };

    window.deleteUser = async (id, name) => {
        if(confirm(`Are you sure you want to delete ${name}?`)) {
            try {
                await fetch(`/api/users/${id}`, {method:'DELETE'});
                addTransaction('delete', name);
                alert("Deleted successfully");
                updateStats();
                if(document.getElementById('viewall-section').classList.contains('active')) loadAllData();
                document.getElementById('searchResult').style.display='none'; 
            } catch(e) { alert("Delete failed"); }
        }
    };

    window.updateStats = async () => {
        try {
            const res = await fetch('/api/health');
            const data = await res.json();
            document.getElementById('totalUsers').innerText = data.node0.rowCount || 0;
            
            const updateStatus = (id, s) => {
                const el = document.getElementById(id);
                if(s === 'connected') { el.style.background='#E2FBD7'; el.style.color='#34B53A'; el.innerText='Connected'; }
                else { el.style.background='#FFE5E5'; el.style.color='#FF4C4C'; el.innerText='Offline'; }
            };
            updateStatus('node0Status', data.node0.status);
            updateStatus('node1Status', data.node1.status);
            updateStatus('node2Status', data.node2.status);
        } catch(e) {}
    }
    updateStats();
});
</script>
</body>
</html>
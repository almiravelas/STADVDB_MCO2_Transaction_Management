<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB Manager</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- GLOBAL & LAYOUT --- */
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: #F4F7FE; color: #2B3674; overflow-x: hidden; }
        * { box-sizing: border-box; }

        /* --- SIDEBAR --- */
        .sidebar { position: fixed; left: 0; top: 0; width: 250px; height: 100vh; background: #fff; padding: 20px; transition: 0.3s; z-index: 100; box-shadow: 2px 0 10px rgba(0,0,0,0.02); }
        .sidebar.collapsed { width: 80px; }
        .sidebar.collapsed .logo-text, .sidebar.collapsed .nav-text { display: none; }
        .sidebar-logo { display: flex; align-items: center; gap: 15px; margin-bottom: 40px; padding: 0 10px; font-weight: 800; font-size: 22px; color: #2B3674; }
        .toggle-btn { position: absolute; right: -15px; top: 25px; background: #fff; border: none; width: 30px; height: 30px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; color: #4318FF; display: flex; align-items: center; justify-content: center; }
        .nav-item { display: flex; align-items: center; gap: 15px; width: 100%; padding: 15px; background: none; border: none; border-radius: 15px; color: #A3AED0; font-size: 15px; cursor: pointer; transition: 0.2s; text-align: left; margin-bottom: 5px; }
        .nav-item:hover { color: #4318FF; background: #F4F7FE; }
        .nav-item.active { background: #4318FF; color: white; box-shadow: 0 10px 20px rgba(67, 24, 255, 0.2); }
        .nav-item i { font-size: 20px; min-width: 20px; }

        /* --- MAIN CONTENT --- */
        .main-content { margin-left: 250px; padding: 30px; transition: 0.3s; }
        .sidebar.collapsed + .main-content { margin-left: 80px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .content-section { display: none; animation: fadeIn 0.4s ease; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARDS & GRID --- */
        .card-clean { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.02); margin-bottom: 20px; }
        .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .overview-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .card-purple { background: linear-gradient(135deg, #868CFF 0%, #4318FF 100%); color: white; padding: 25px; border-radius: 20px; position: relative; overflow: hidden; }
        .card-pink { background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 99%, #FECFEF 100%); color: white; padding: 25px; border-radius: 20px; }

        /* --- FORMS & INPUTS --- */
        .input-field { width: 100%; padding: 12px 15px; background: #F4F7FE; border: none; border-radius: 10px; outline: none; margin-bottom: 15px; color: #2B3674; font-size: 14px; }
        .input-field:focus { box-shadow: 0 0 0 2px rgba(67, 24, 255, 0.1); }
        label { display: block; font-size: 12px; font-weight: 700; color: #A3AED0; margin-bottom: 5px; margin-left: 5px; }

        /* --- BUTTONS --- */
        .btn-primary { background: #4318FF; color: white; padding: 12px 25px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-primary:hover { background: #3311CC; transform: translateY(-2px); }
        .btn-soft { width: 35px; height: 35px; border-radius: 10px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-soft-blue { background: #F4F7FE; color: #4318FF; }
        .btn-soft-red { background: #FFF5F5; color: #FF5252; }
        .btn-refresh { background: none; border: 1px solid #E0E5F2; color: #2B3674; padding: 8px 15px; border-radius: 30px; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-refresh:hover { background: #F4F7FE; }
        .qa-btn { background: rgba(255,255,255,0.2); border: none; padding: 10px; width: 100%; border-radius: 10px; color: white; cursor: pointer; display: flex; align-items: center; gap: 10px; margin-top: 10px; font-size: 13px; transition: 0.2s; }
        .qa-btn:hover { background: rgba(255,255,255,0.3); }

        /* --- TABLES & LISTS --- */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { text-align: left; padding: 15px 10px; color: #A3AED0; font-size: 12px; font-weight: 600; border-bottom: 1px solid #F4F7FE; }
        .data-table td { padding: 15px 10px; font-size: 14px; font-weight: 600; color: #2B3674; border-bottom: 1px solid #F4F7FE; }
        .user-card-new { display: flex; align-items: center; gap: 15px; padding: 15px; background: white; border-radius: 15px; margin-bottom: 15px; border: 1px solid #F4F7FE; transition: 0.2s; }
        .user-card-new:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .uc-icon { width: 45px; height: 45px; background: #F4F7FE; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #4318FF; font-size: 20px; }
        .history-item { display: flex; align-items: center; gap: 15px; padding: 15px 0; border-bottom: 1px solid #F4F7FE; }
        .h-icon { width: 35px; height: 35px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 100%; max-width: 450px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- CONCURRENCY LAB STYLES --- */
        .sim-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .log-box { background: #1B254B; color: #00E396; padding: 15px; border-radius: 10px; height: 250px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.5; margin-top: 10px; border: 1px solid #2B3674; }
        .case-card { background: #F4F7FE; padding: 15px; border-radius: 15px; text-align: center; cursor: pointer; transition: 0.2s; border: 2px solid transparent; }
        .case-card:hover { border-color: #4318FF; background: #fff; }
        .case-card h4 { margin: 0 0 5px 0; color: #2B3674; }
        .case-card p { margin: 0; font-size: 12px; color: #A3AED0; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .badge-read { background: #E2FBD7; color: #34B53A; }
        .badge-write { background: #FFE5E5; color: #FF4C4C; }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <button class="toggle-btn" id="sidebarToggle"><i class='bx bx-chevron-left'></i></button>
        <div class="sidebar-logo">
            <div style="width:35px; height:35px; background:rgba(67, 24, 255, 0.1); border-radius:8px; display:flex; align-items:center; justify-content:center; color:#4318FF;">
                <i class='bx bxs-component'></i>
            </div>
            <span class="logo-text">DB Admin</span>
        </div>
        <nav>
            <button class="nav-item active" data-view="overview"><i class='bx bxs-dashboard'></i><span class="nav-text">Dashboard</span></button>
            <button class="nav-item" data-view="concurrency"><i class='bx bx-git-compare'></i><span class="nav-text">Concurrency Lab</span></button>
            <button class="nav-item" data-view="failure"><i class='bx bx-failure'><span class="nav-text">Global Failure Recovery</span></i></button>
            <button class="nav-item" data-view="search"><i class='bx bx-search-alt'></i><span class="nav-text">Search User</span></button>
            <button class="nav-item" data-view="country"><i class='bx bxs-map-alt'></i><span class="nav-text">Filter Location</span></button>
            <button class="nav-item" data-view="viewall"><i class='bx bxs-folder'></i><span class="nav-text">View All Data</span></button>
            <div style="margin-top:auto; padding-top:20px; border-top:1px solid #F4F7FE;">
                <button class="nav-item" data-view="health"><i class='bx bx-pulse'></i><span class="nav-text">System Health</span></button>
            </div>
        </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <header class="header">
            <div>
                <p style="font-size:12px; color:#A3AED0; margin:0;">Pages / <span id="breadcrumb">Dashboard</span></p>
                <h1 id="pageTitle" style="margin:5px 0 0 0; font-size:28px;">Main Dashboard</h1>
            </div>
            <button class="btn-primary" id="btnAddUser"><i class='bx bx-plus'></i><span>Add User</span></button>
        </header>

        <!-- 1. OVERVIEW SECTION -->
        <section id="overview-section" class="content-section active">
            <div class="dashboard-grid">
                <div class="stats-area">
                    <div class="overview-row">
                        <div class="card-purple">
                            <p style="opacity:0.8; font-size:12px; text-transform:uppercase; letter-spacing:1px;">Total Users</p>
                            <h1 id="totalUsers" style="font-size:36px; margin:5px 0;">--</h1>
                            <p style="opacity:0.8; font-size:13px;">Active database records</p>
                        </div>
                        <div class="card-pink">
                            <h3 style="font-size:16px; margin:0 0 10px 0;">Quick Actions</h3>
                            <button class="qa-btn" onclick="document.querySelector('[data-view=concurrency]').click()">
                                <i class='bx bx-test-tube' style="font-size:20px;"></i> <span>Concurrency Test</span>
                            </button>
                            <button class="qa-btn" onclick="document.querySelector('[data-view=country]').click()">
                                <i class='bx bx-map' style="font-size:20px;"></i> <span>Filter Country</span>
                            </button>
                        </div>
                    </div>
                    <div class="card-clean" style="height:300px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3 style="color:#2B3674; font-size:18px; margin:0;">Registration Analytics</h3>
                            <span style="background:#F4F7FE; color:#6C5CE7; padding:5px 15px; border-radius:20px; font-size:12px; font-weight:600;">Monthly View</span>
                        </div>
                        <canvas id="growthChart"></canvas>
                    </div>
                </div>
                <div class="card-clean history-panel">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <h3 style="font-size:16px; margin:0;">Activity Log</h3>
                        <button onclick="clearHistory()" style="border:none; background:none; color:#FF6B9D; cursor:pointer; font-weight:600; font-size:12px;">Clear</button>
                    </div>
                    <div id="transactionList"><p style="color:#aaa; text-align:center; font-size:12px;">No recent activity</p></div>
                </div>
            </div>
        </section>

        <!-- 2. CONCURRENCY LAB SECTION -->
        <section id="concurrency-section" class="content-section">
            <div class="card-clean">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <div>
                        <h2 style="margin:0;">Simulation Control</h2>
                        <p style="color:#A3AED0; font-size:13px; margin:5px 0 0 0;">Test isolation levels and locking mechanisms</p>
                    </div>
                    <button class="btn-primary" onclick="createTestUser()">
                        <i class='bx bx-reset'></i> Reset User 101
                    </button>
                </div>

                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:25px;">
                    <div class="case-card" onclick="setCase(1)">
                        <h4>Case 1: Read-Read</h4>
                        <p>No blocking expected</p>
                    </div>
                    <div class="case-card" onclick="setCase(2)">
                        <h4>Case 2: Write-Read</h4>
                        <p>Tests Isolation Levels</p>
                    </div>
                    <div class="case-card" onclick="setCase(3)">
                        <h4>Case 3: Write-Write</h4>
                        <p>Tests Row Locking</p>
                    </div>
                </div>

                <div style="background: #F4F7FE; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #E0E5F2;">
                    <label style="margin-bottom: 8px;">Target User ID (Critical for Concurrency)</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="simGlobalId" class="input-field" placeholder="e.g. 101 (Leave EMPTY for Random User)" style="margin-bottom: 0;">
                        <button class="btn-primary" onclick="runSimulation()" style="white-space: nowrap; background:#111;">
                            <i class='bx bx-play'></i> RUN SIMULATION
                        </button>
                    </div>
                    <p style="font-size: 11px; color: #A3AED0; margin: 5px 0 0 5px;">
                        * If separate transactions target different users (Random), no locking will occur. 
                        * To test locking, enter a specific ID (e.g., 101).
                    </p>
                </div>

                <div class="sim-grid">
                    <div style="background:#FAFAFA; padding:20px; border-radius:15px; border:1px solid #E0E5F2;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                            <h3 style="margin:0; font-size:16px;">Transaction A</h3>
                            <span class="badge badge-write" id="badgeA">WRITE</span>
                        </div>
                        <form id="formA">
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                <div>
                                    <label>Operation</label>
                                    <select name="type" class="input-field" onchange="updateBadge('A', this.value)">
                                        <option value="WRITE">WRITE (Update)</option>
                                        <option value="READ">READ</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Duration (s)</label>
                                    <input type="number" name="sleepTime" class="input-field" value="5">
                                </div>
                            </div>
                            <label>Isolation Level</label>
                            <select name="isolation" class="input-field">
                                <option value="READ UNCOMMITTED">READ UNCOMMITTED</option>
                                <option value="READ COMMITTED">READ COMMITTED</option>
                                <option value="REPEATABLE READ">REPEATABLE READ</option>
                                <option value="SERIALIZABLE">SERIALIZABLE</option>
                            </select>
                            <label>Update Text (If Write)</label>
                            <input type="text" name="updateText" class="input-field" value="Trans_A_Data">
                        </form>
                        <div class="log-box" id="logA">Waiting to start...</div>
                    </div>

                    <div style="background:#FAFAFA; padding:20px; border-radius:15px; border:1px solid #E0E5F2;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                            <h3 style="margin:0; font-size:16px;">Transaction B</h3>
                            <span class="badge badge-read" id="badgeB">READ</span>
                        </div>
                        <form id="formB">
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                <div>
                                    <label>Operation</label>
                                    <select name="type" class="input-field" onchange="updateBadge('B', this.value)">
                                        <option value="READ">READ</option>
                                        <option value="WRITE">WRITE (Update)</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Duration (s)</label>
                                    <input type="number" name="sleepTime" class="input-field" value="1">
                                </div>
                            </div>
                            <label>Isolation Level</label>
                            <select name="isolation" class="input-field">
                                <option value="READ UNCOMMITTED">READ UNCOMMITTED</option>
                                <option value="READ COMMITTED">READ COMMITTED</option>
                                <option value="REPEATABLE READ">REPEATABLE READ</option>
                                <option value="SERIALIZABLE">SERIALIZABLE</option>
                            </select>
                            
                            <label>Update Text (If Write)</label>
                            <input type="text" name="updateText" class="input-field" value="Trans_B_Data">

                            <div class="log-box" id="logB" style="margin-top:15px;">Waiting to start...</div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!--GLOBAL FAILURE RECOVERY SECTION -->
        <section id="failure-section" class="content-section">
            <div class="card-clean">
                <h2 style="margin:0;">Failure Recovery Simulator</h2>
                <p style="color:#A3AED0; font-size:13px; margin:5px 0 20px 0;">Simulate node failures, recovery, and replica synchronization.</p>
            <!-- NODE CONTROLS -->
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; margin-top:20px;">
            
                <!-- Node 1 -->
                <div class="card-clean" style="text-align:center;">
                    <h3>Node 1</h3>
                    <p id="node1-status" style="font-size:14px; color:#34B53A;">ONLINE</p>
                    <button class="btn-primary" onclick="toggleNode(0, this)"><i class='bx bx-power-off'></i> Toggle</button>
                </div>

                <!-- Node 2 -->
                <div class="card-clean" style="text-align:center;">
                    <h3>Node 2</h3>
                    <p id="node2-status" style="font-size:14px; color:#34B53A;">ONLINE</p>
                    <button class="btn-primary" onclick="toggleNode(1, this)"><i class='bx bx-power-off'></i> Toggle</button>
                </div>

                <!-- Node 3 -->
                <div class="card-clean" style="text-align:center;">
                    <h3>Node 3</h3>
                    <p id="node3-status" style="font-size:14px; color:#34B53A;">ONLINE</p>
                    <button class="btn-primary" onclick="toggleNode(2, this)"><i class='bx bx-power-off'></i> Toggle</button>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:20px;">
            
                <!-- Case 1 -->
                <div class="card-clean" style="text-align:center;">
                    <h3>Case 1</h3>
                    <p id="node1-status" style="font-size:14px; color:#34B53A;">ONLINE</p>
                    <button class="btn-primary" onclick="runCase1()"><i class='bx bx-power-off'></i> Run</button>
                </div>

                <!-- Case 2 -->
                <div class="card-clean" style="text-align:center;">
                    <h3>Case 2</h3>
                    <p id="node2-status" style="font-size:14px; color:#34B53A;">ONLINE</p>
                    <button class="btn-primary" onclick="runCase2()"><i class='bx bx-power-off'></i> Run</button>
                </div>

                <!-- Case 3 -->
                <div class="card-clean" style="text-align:center;">
                    <h3>Case 3</h3>
                    <p id="node3-status" style="font-size:14px; color:#34B53A;">ONLINE</p>
                    <button class="btn-primary" onclick="runCase3()"><i class='bx bx-power-off'></i> Run</button>
                </div>

                <!-- Case 4 -->
                <div class="card-clean" style="text-align:center;">
                    <h3>Case 4</h3>
                    <p id="node3-status" style="font-size:14px; color:#34B53A;">ONLINE</p>
                    <button class="btn-primary" onclick="runCase4()"><i class='bx bx-power-off'></i> Run</button>
                </div>
            </div>

        <h3 style="margin-top:30px;">Event Log</h3>
        <div class="log-box" id="failureLog">System idle...</div>
    </div>
</section>
        <!-- 3. SEARCH SECTION -->
        <section id="search-section" class="content-section">
            <div class="card-clean">
                <h2>Search User</h2>
                <form id="searchForm" style="display:flex; gap:15px; margin-top:25px;">
                    <input type="text" id="searchId" class="input-field" placeholder="ID or Name..." style="margin-bottom:0;" required>
                    <button type="submit" class="btn-primary">Search</button>
                </form>
                <div id="searchResult" style="display:none; margin-top:30px; background:#FAFAFA; padding:25px; border-radius:20px; border:1px solid #eee;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h2 id="resultName" style="color:#333; margin:0;">Name</h2>
                            <p style="color:#888; margin:5px 0 0 0;">ID: <span id="resultId">--</span> | <span id="resultCity">--</span></p>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button id="btnEditSearch" class="btn-soft btn-soft-blue" title="Edit"><i class='bx bx-edit-alt'></i></button>
                            <button id="btnDeleteSearch" class="btn-soft btn-soft-red" title="Delete"><i class='bx bx-trash'></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. FILTER SECTION -->
        <section id="country-section" class="content-section">
            <div class="card-clean">
                <h2>Filter Location</h2>
                <form id="countryForm" style="display:flex; gap:15px; margin-top:20px;">
                    <select id="countrySelect" class="input-field" style="margin-bottom:0;">
                        <option value="">Select Country...</option>
                        <option value="Philippines">Philippines</option>
                        <option value="USA">USA</option>
                        <option value="Mexico">Mexico</option>
                        <option value="Canada">Canada</option>
                        <option value="Australia">Australia</option>
                        <option value="Germany">Germany</option>
                    </select>
                    <button type="submit" class="btn-primary">Filter</button>
                </form>
                <div id="usersList" style="margin-top:30px; display:none;">
                    <h3 style="margin-bottom:15px; color:#2B3674;">Results</h3>
                    <div id="usersContainer" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:15px;"></div>
                </div>
            </div>
        </section>

        <!-- 5. VIEW ALL SECTION -->
        <section id="viewall-section" class="content-section">
            <div class="card-clean">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>All Records</h2>
                    <span style="background:#E2FBD7; color:#34B53A; padding:5px 12px; border-radius:20px; font-size:12px; font-weight:600;">Live Data</span>
                </div>
                <div style="overflow-x:auto; margin-top:20px;">
                    <table class="data-table">
                        <thead>
                            <tr style="border-bottom:1px solid #F4F7FE; color:#A3AED0; font-size:12px;">
                                <th style="padding:15px;">ID</th><th>USERNAME</th><th>NAME</th><th>COUNTRY</th><th style="text-align:right;">ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="allDataTableBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- 6. HEALTH SECTION -->
        <section id="health-section" class="content-section">
            <div class="card-clean">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>System Health</h2>
                    <button class="btn-refresh" onclick="updateStats()">
                        <i class='bx bx-refresh'></i> Refresh
                    </button>
                </div>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; margin-top:30px;">
                    <div class="card-clean" style="text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.05);">
                        <i class='bx bx-server' style="font-size:40px; color:#6C5CE7;"></i>
                        <h3 style="margin:10px 0 5px 0; color:#2B3674;">Central DB</h3>
                        <p style="font-size:12px; color:#A3AED0; margin-bottom:15px;">Master Node</p>
                        <span id="node0Status" style="background:#E2FBD7; color:#34B53A; padding:5px 12px; border-radius:15px; font-weight:600; font-size:12px;">Connected</span>
                    </div>
                    <div class="card-clean" style="text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.05);">
                        <i class='bx bx-hdd' style="font-size:40px; color:#FF6B9D;"></i>
                        <h3 style="margin:10px 0 5px 0; color:#2B3674;">Partition 1</h3>
                        <p style="font-size:12px; color:#A3AED0; margin-bottom:15px;">M-Z Countries</p>
                        <span id="node1Status" style="background:#E2FBD7; color:#34B53A; padding:5px 12px; border-radius:15px; font-weight:600; font-size:12px;">Connected</span>
                    </div>
                    <div class="card-clean" style="text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.05);">
                        <i class='bx bx-hdd' style="font-size:40px; color:#FF6B9D;"></i>
                        <h3 style="margin:10px 0 5px 0; color:#2B3674;">Partition 2</h3>
                        <p style="font-size:12px; color:#A3AED0; margin-bottom:15px;">A-L Countries</p>
                        <span id="node2Status" style="background:#E2FBD7; color:#34B53A; padding:5px 12px; border-radius:15px; font-weight:600; font-size:12px;">Connected</span>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- EDIT USER MODAL -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" style="text-align:center; margin-bottom:20px; color:#2B3674;">Edit User</h2>
            <form id="userForm">
                <label>ID</label>
                <input type="number" id="userId" class="input-field" placeholder="User ID" required>
                
                <div style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label>First Name</label>
                        <input type="text" id="firstName" class="input-field" placeholder="First Name" required>
                    </div>
                    <div style="flex:1">
                        <label>Last Name</label>
                        <input type="text" id="lastName" class="input-field" placeholder="Last Name" required>
                    </div>
                </div>

                <label>Username (Auto-generated if empty)</label>
                <input type="text" id="username" class="input-field" placeholder="Username">

                <div style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label>City</label>
                        <input type="text" id="city" class="input-field" placeholder="City" required>
                    </div>
                    <div style="flex:1">
                        <label>Country</label>
                        <select id="country" class="input-field" required>
                            <option value="Philippines">Philippines</option>
                            <option value="USA">USA</option>
                            <option value="Mexico">Mexico</option>
                            <option value="Canada">Canada</option>
                            <option value="Australia">Australia</option>
                            <option value="Germany">Germany</option>
                        </select>
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button type="button" id="btnCancelModal" style="flex:1; padding:12px; background:#f0f0f0; border:none; border-radius:10px; cursor:pointer;">Cancel</button>
                    <button type="submit" class="btn-primary" style="flex:1; justify-content:center;">Save</button>
                </div>
            </form>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // 1. SIDEBAR TOGGLE
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('sidebarToggle');
    toggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        toggleBtn.querySelector('i').classList.toggle('bx-chevron-right');
        toggleBtn.querySelector('i').classList.toggle('bx-chevron-left');
    });

    // 2. CHART (Mock Data)
    const ctx = document.getElementById('growthChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'New Users',
                data: [12, 19, 3, 5, 2, 15],
                borderColor: '#4318FF',
                backgroundColor: 'rgba(67, 24, 255, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, grid:{borderDash:[5,5]} }, x:{grid:{display:false}} }
        }
    });

    // 3. NAVIGATION HANDLER
    const navButtons = document.querySelectorAll('[data-view]');
    const sections = document.querySelectorAll('.content-section');
    const title = document.getElementById('pageTitle');
    const breadcrumb = document.getElementById('breadcrumb');

    navButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const view = btn.getAttribute('data-view');
            navButtons.forEach(b => b.classList.remove('active'));
            sections.forEach(s => s.classList.remove('active'));
            
            btn.classList.add('active');
            document.getElementById(view + '-section').classList.add('active');
            
            if(view === 'viewall') loadAllData();
            if(view === 'overview') updateStats();
            
            const titles = { 
                overview: 'Main Dashboard', 
                concurrency: 'Concurrency Lab',
                search: 'Search Database', 
                country: 'Filter Location', 
                viewall: 'All Records', 
                health: 'System Health' 
            };
            title.innerText = titles[view];
            breadcrumb.innerText = titles[view];
        });
    });

    // 4. CONCURRENCY LAB FUNCTIONS
    window.setCase = (num) => {
        const fA = document.getElementById('formA');
        const fB = document.getElementById('formB');
        
        // Reset badges
        window.updateBadge('A', num === 2 || num === 3 ? 'WRITE' : 'READ');
        window.updateBadge('B', num === 3 ? 'WRITE' : 'READ');

        if(num === 1) { // Read-Read
            fA.type.value = 'READ'; fA.sleepTime.value = 5;
            fB.type.value = 'READ'; fB.sleepTime.value = 1;
        } else if(num === 2) { // Write-Read
            fA.type.value = 'WRITE'; fA.sleepTime.value = 5; fA.updateText.value = "DIRTY_DATA";
            fB.type.value = 'READ'; fB.sleepTime.value = 1;
        } else if(num === 3) { // Write-Write
            fA.type.value = 'WRITE'; fA.sleepTime.value = 5; fA.updateText.value = "LOCK_HOLDER";
            fB.type.value = 'WRITE'; fB.sleepTime.value = 1;
        }
    };

    window.updateBadge = (trans, type) => {
        const badge = document.getElementById(`badge${trans}`);
        badge.innerText = type;
        if(type === 'WRITE') { badge.className = 'badge badge-write'; }
        else { badge.className = 'badge badge-read'; }
    };

    window.createTestUser = async () => {
        const data = { id: 101, username: 'sim_user', firstName: 'Original', lastName: 'User', country: 'Philippines', city: 'Manila' };
        try {
            await fetch('/api/users', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            alert("User 101 Created/Reset Successfully");
            addTransaction('add', 'User 101');
        } catch(e) { alert("Error creating user: " + e.message); }
    };

    window.runSimulation = async () => {
        // 1. Get the Global ID (or empty for random)
        const targetId = document.getElementById('simGlobalId').value.trim();
        
        // 2. Get Form Data
        const formA = new FormData(document.getElementById('formA'));
        const formB = new FormData(document.getElementById('formB'));
        
        // 3. Construct Payload with the Shared ID
        const dataA = { ...Object.fromEntries(formA.entries()), id: targetId };
        const dataB = { ...Object.fromEntries(formB.entries()), id: targetId };

        // UI Feedback
        document.getElementById('logA').innerHTML = ">> Transaction Started...";
        document.getElementById('logB').innerHTML = ">> Waiting 1s delay...";
        
        // Helper function to safely render logs
        const renderLogs = (elementId, data, error) => {
            const el = document.getElementById(elementId);
            if (error) {
                el.innerHTML = `<span style="color:red"><b>Frontend Error:</b> ${error}</span>`;
                return;
            }
            
            // SAFETY CHECK: Ensure logs exist and is an array
            const logContent = (data.logs && Array.isArray(data.logs)) 
                ? data.logs.join('<br>') 
                : `<span style="color:orange">Warning: No logs returned. (Backend may have crashed or returned: ${JSON.stringify(data)})</span>`;

            const idMsg = data.targetId ? `[ID: ${data.targetId}] ` : "";
            el.innerHTML = `<b>${idMsg}</b><br>` + logContent;
        };

        // 4. Execute Transaction A
        const pA = fetch('/api/simulate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(dataA)
        })
        .then(r => r.json())
        .then(d => renderLogs('logA', d))
        .catch(e => renderLogs('logA', null, e.message));

        // 5. Execute Transaction B (Delayed)
        await new Promise(r => setTimeout(r, 1000));
        
        const pB = fetch('/api/simulate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(dataB)
        })
        .then(r => r.json())
        .then(d => renderLogs('logB', d))
        .catch(e => renderLogs('logB', null, e.message));

        await Promise.all([pA, pB]);
    };

    // 5. GENERIC CRUD
    const modal = document.getElementById('userModal');
    document.getElementById('btnAddUser').onclick = () => { 
        modal.style.display='flex'; 
        document.getElementById('userForm').reset(); 
        document.getElementById('userId').disabled = false;
        document.getElementById('modalTitle').innerText="Add New User"; 
    };
    document.getElementById('btnCancelModal').onclick = () => modal.style.display='none';

    document.getElementById('userForm').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('userId').value;
        const data = {
            id: id,
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            username: document.getElementById('username').value,
            city: document.getElementById('city').value,
            country: document.getElementById('country').value
        };
        const method = document.getElementById('userId').disabled ? 'PUT' : 'POST';
        const url = document.getElementById('userId').disabled ? `/api/users/${id}` : '/api/users';
        
        try {
            await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            addTransaction(method === 'POST' ? 'add' : 'edit', data.firstName);
            alert("Success!");
            modal.style.display='none';
            updateStats();
            if(document.getElementById('viewall-section').classList.contains('active')) loadAllData();
        } catch(e) { alert("Error: " + e.message); }
    };

    // 6. SHARED FUNCTIONS
    window.editUser = (id,f,l,u,c,co) => {
        modal.style.display='flex';
        document.getElementById('userId').value=id; 
        document.getElementById('userId').disabled=true; // ID cannot be changed on edit
        document.getElementById('firstName').value=f;
        document.getElementById('lastName').value=l; 
        document.getElementById('username').value=u;
        document.getElementById('city').value=c; 
        document.getElementById('country').value=co;
        document.getElementById('modalTitle').innerText="Edit User";
    };

    window.deleteUser = async (id, name) => {
        if(confirm(`Are you sure you want to delete ${name}?`)) {
            try {
                await fetch(`/api/users/${id}`, {method:'DELETE'});
                addTransaction('delete', name);
                alert("Deleted successfully");
                updateStats();
                if(document.getElementById('viewall-section').classList.contains('active')) loadAllData();
                document.getElementById('searchResult').style.display='none'; 
            } catch(e) { alert("Delete failed"); }
        }
    };

    window.loadAllData = async () => {
        const tbody = document.getElementById('allDataTableBody');
        tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
        try {
            const res = await fetch('/api/node/1/data?limit=50');
            const json = await res.json();
            tbody.innerHTML = '';
            if(json.data) {
                json.data.forEach(u => {
                    tbody.innerHTML += `
                    <tr>
                        <td style="padding:15px;">${u.id}</td>
                        <td>${u.username}</td>
                        <td>${u.firstName} ${u.lastName}</td>
                        <td>${u.country}</td>
                        <td style="text-align:right;">
                            <div style="display:flex; justify-content:flex-end; gap:5px;">
                                <button class="btn-soft btn-soft-blue" onclick="editUser('${u.id}','${u.firstName}','${u.lastName}','${u.username}','${u.city}','${u.country}')"><i class='bx bx-edit-alt'></i></button>
                                <button class="btn-soft btn-soft-red" onclick="deleteUser('${u.id}','${u.firstName}')"><i class='bx bx-trash'></i></button>
                            </div>
                        </td>
                    </tr>`;
                });
            }
        } catch(e) { tbody.innerHTML = '<tr><td colspan="5">Error loading data</td></tr>'; }
    };

    window.updateStats = async () => {
        try {
            const res = await fetch('/api/health');
            const data = await res.json();
            document.getElementById('totalUsers').innerText = data.node0.rowCount || 0;
            
            const updateStatus = (id, s) => {
                const el = document.getElementById(id);
                if(s === 'connected') { el.style.background='#E2FBD7'; el.style.color='#34B53A'; el.innerText='Connected'; }
                else { el.style.background='#FFE5E5'; el.style.color='#FF4C4C'; el.innerText='Offline'; }
            };
            updateStatus('node0Status', data.node0.status);
            updateStatus('node1Status', data.node1.status);
            updateStatus('node2Status', data.node2.status);
        } catch(e) {}
    };

    // HISTORY HELPER
    window.addTransaction = (type, name) => {
        const history = JSON.parse(localStorage.getItem('dbHistory')) || [];
        history.unshift({ type, name, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
        if(history.length > 10) history.pop();
        localStorage.setItem('dbHistory', JSON.stringify(history));
        renderHistory();
    };
    
    window.clearHistory = () => { localStorage.removeItem('dbHistory'); renderHistory(); };

    function renderHistory() {
        const list = document.getElementById('transactionList');
        const history = JSON.parse(localStorage.getItem('dbHistory')) || [];
        if(history.length === 0) { list.innerHTML = '<p style="color:#aaa; font-size:12px; text-align:center;">No recent activity</p>'; return; }

        list.innerHTML = '';
        history.forEach(h => {
            let color = '#6C5CE7', icon = 'bx-plus';
            if(h.type === 'edit') { color = '#2196F3'; icon = 'bx-pencil'; }
            if(h.type === 'delete') { color = '#FF5252'; icon = 'bx-trash'; }

            list.innerHTML += `
                <div class="history-item">
                    <div class="h-icon" style="background:${color};">
                        <i class='bx ${icon}'></i>
                    </div>
                    <div>
                        <p style="font-weight:600; font-size:14px; color:#2B3674; margin:0; text-transform:capitalize;">${h.type}</p>
                        <p style="font-size:12px; color:#A0A5BA; margin:0;">${h.name}</p>
                    </div>
                </div>`;
        });
    }
    renderHistory();
    updateStats();
});
</script>
<script src="/failure.js"></script>
</body>
</html>